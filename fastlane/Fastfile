# Fastfile for MirrorSmoker (Fight The Smoke)
# Comprehensive App Store submission and metadata management

default_platform(:ios)

platform :ios do
  # ===== CONFIGURATION =====
  
  before_all do
    setup_circle_ci if ENV['CIRCLECI']
    ensure_git_clean if ENV['CI']
  end
  
  # ===== APP STORE METADATA =====
  
  desc "üìù Update App Store metadata and descriptions"
  lane :update_metadata do
    deliver(
      app_identifier: "com.mirror-labs.MirrorSmokerStopper",
      skip_screenshots: true,
      skip_binary_upload: true,
      skip_app_version_update: true,
      force: true,
      
      # App Information
      name: {
        'en-US' => 'Fight The Smoke',
        'es-ES' => 'Fight The Smoke',
        'fr-FR' => 'Fight The Smoke', 
        'de-DE' => 'Fight The Smoke',
        'it-IT' => 'Fight The Smoke'
      },
      
      subtitle: {
        'en-US' => 'Smart Smoking Tracker',
        'es-ES' => 'Seguimiento Inteligente',
        'fr-FR' => 'Suivi Intelligent',
        'de-DE' => 'Intelligente Verfolgung',
        'it-IT' => 'Tracker Intelligente'
      },
      
      description: {
        'en-US' => 'Track your smoking habits with AI-powered insights. Fight The Smoke helps you understand your patterns, set goals, and work towards a healthier lifestyle with personalized coaching and detailed analytics.',
        'es-ES' => 'Rastrea tus h√°bitos de fumar con insights impulsados por IA. Fight The Smoke te ayuda a entender tus patrones, establecer objetivos y trabajar hacia un estilo de vida m√°s saludable.',
        'fr-FR' => 'Suivez vos habitudes de tabagisme avec des insights aliment√©s par IA. Fight The Smoke vous aide √† comprendre vos habitudes et √† travailler vers un mode de vie plus sain.',
        'de-DE' => 'Verfolgen Sie Ihre Rauchgewohnheiten mit KI-gest√ºtzten Erkenntnissen. Fight The Smoke hilft Ihnen, Ihre Muster zu verstehen und an einem ges√ºnderen Lebensstil zu arbeiten.',
        'it-IT' => 'Traccia le tue abitudini di fumo con insights alimentati da IA. Fight The Smoke ti aiuta a capire i tuoi pattern e lavorare verso uno stile di vita pi√π sano.'
      },
      
      keywords: {
        'en-US' => 'smoking,tracker,health,quit,habits,AI,coach,analytics,wellness,lifestyle',
        'es-ES' => 'fumar,rastreador,salud,dejar,h√°bitos,IA,entrenador,anal√≠tica,bienestar',
        'fr-FR' => 'fumer,suivi,sant√©,arr√™ter,habitudes,IA,coach,analyse,bien-√™tre',
        'de-DE' => 'rauchen,verfolgen,gesundheit,aufh√∂ren,gewohnheiten,KI,coach,analyse',
        'it-IT' => 'fumare,tracciare,salute,smettere,abitudini,IA,coach,analisi,benessere'
      },
      
      marketing_url: {
        'en-US' => 'https://www.fightthestroke.org/mirror-labs',
        'es-ES' => 'https://www.fightthestroke.org/mirror-labs',
        'fr-FR' => 'https://www.fightthestroke.org/mirror-labs',
        'de-DE' => 'https://www.fightthestroke.org/mirror-labs',
        'it-IT' => 'https://www.fightthestroke.org/mirror-labs'
      },
      
      support_url: {
        'en-US' => 'https://www.fightthestroke.org/mirror-labs/support',
        'es-ES' => 'https://www.fightthestroke.org/mirror-labs/support',
        'fr-FR' => 'https://www.fightthestroke.org/mirror-labs/support',
        'de-DE' => 'https://www.fightthestroke.org/mirror-labs/support',
        'it-IT' => 'https://www.fightthestroke.org/mirror-labs/support'
      },
      
      privacy_url: {
        'en-US' => 'https://www.fightthestroke.org/mirror-labs/privacy',
        'es-ES' => 'https://www.fightthestroke.org/mirror-labs/privacy',
        'fr-FR' => 'https://www.fightthestroke.org/mirror-labs/privacy',
        'de-DE' => 'https://www.fightthestroke.org/mirror-labs/privacy',
        'it-IT' => 'https://www.fightthestroke.org/mirror-labs/privacy'
      },
      
      # Promotional Text
      promotional_text: {
        'en-US' => 'üî• New AI Coach feature! Get personalized insights and smart recommendations to help you achieve your goals.',
        'es-ES' => 'üî• ¬°Nueva funci√≥n de Entrenador IA! Obt√©n insights personalizados y recomendaciones inteligentes.',
        'fr-FR' => 'üî• Nouvelle fonctionnalit√© Coach IA ! Obtenez des insights personnalis√©s et des recommandations intelligentes.',
        'de-DE' => 'üî• Neue KI-Coach Funktion! Erhalten Sie personalisierte Erkenntnisse und intelligente Empfehlungen.',
        'it-IT' => 'üî• Nuova funzione Coach IA! Ottieni insights personalizzati e raccomandazioni intelligenti.'
      },
      
      # Release Notes
      release_notes: {
        'en-US' => "üî• NEW AI COACH FEATURE\n‚Ä¢ Personalized insights and recommendations\n‚Ä¢ Smart pattern recognition\n‚Ä¢ Enhanced analytics dashboard\n‚Ä¢ Improved Apple Watch integration\n‚Ä¢ Performance optimizations",
        'es-ES' => "üî• NUEVA FUNCI√ìN ENTRENADOR IA\n‚Ä¢ Insights y recomendaciones personalizadas\n‚Ä¢ Reconocimiento inteligente de patrones\n‚Ä¢ Panel de an√°lisis mejorado\n‚Ä¢ Mejor integraci√≥n con Apple Watch\n‚Ä¢ Optimizaciones de rendimiento",
        'fr-FR' => "üî• NOUVELLE FONCTION COACH IA\n‚Ä¢ Insights et recommandations personnalis√©s\n‚Ä¢ Reconnaissance intelligente des motifs\n‚Ä¢ Tableau de bord d'analyse am√©lior√©\n‚Ä¢ Int√©gration Apple Watch am√©lior√©e\n‚Ä¢ Optimisations de performance",
        'de-DE' => "üî• NEUE KI-COACH FUNKTION\n‚Ä¢ Personalisierte Erkenntnisse und Empfehlungen\n‚Ä¢ Intelligente Mustererkennung\n‚Ä¢ Verbessertes Analyse-Dashboard\n‚Ä¢ Verbesserte Apple Watch Integration\n‚Ä¢ Performance-Optimierungen",
        'it-IT' => "üî• NUOVA FUNZIONE COACH IA\n‚Ä¢ Insights e raccomandazioni personalizzati\n‚Ä¢ Riconoscimento intelligente dei pattern\n‚Ä¢ Dashboard di analisi migliorata\n‚Ä¢ Integrazione Apple Watch migliorata\n‚Ä¢ Ottimizzazioni delle performance"
      },
      
      # App Store Information
      primary_category: "MedicalCategory",
      secondary_category: "HealthAndFitnessCategory",
      
      # Age Rating
      app_rating_config_path: "./fastlane/metadata/app_rating_config.json"
    )
    
    UI.success("‚úÖ App Store metadata updated successfully!")
  end
  
  # ===== SCREENSHOT MANAGEMENT =====
  
  desc "üì± Upload screenshots to App Store Connect"
  lane :upload_screenshots do
    deliver(
      app_identifier: "com.mirror-labs.MirrorSmokerStopper",
      skip_metadata: true,
      skip_binary_upload: true,
      skip_app_version_update: true,
      force: true,
      
      # Screenshots from your manual captures
      screenshots_path: "./screenshots",
      
      # Override previous screenshots
      overwrite_screenshots: true
    )
    
    UI.success("‚úÖ Screenshots uploaded to App Store Connect!")
  end
  
  # ===== BUILD LANES =====
  
  desc "üî® Build app for release"
  lane :build do
    # Increment build number
    increment_build_number(xcodeproj: "MirrorSmokerStopper.xcodeproj")
    
    # Build the app
    build_app(
      project: "MirrorSmokerStopper.xcodeproj",
      scheme: "MirrorSmokerStopper",
      configuration: "Release",
      clean: true,
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "com.mirror-labs.MirrorSmokerStopper" => "MirrorSmokerStopper App Store",
          "com.mirror-labs.MirrorSmokerStopper.HomeWidget" => "HomeWidget App Store",
          "com.mirror-labs.MirrorSmokerStopper.watchkitapp" => "MirrorSmokerStopper Watch App Store"
        }
      },
      include_bitcode: false,
      include_symbols: true
    )
    
    UI.success("‚úÖ Build completed successfully!")
  end
  
  # ===== SUBMISSION LANES =====
  
  desc "üöÄ Submit to TestFlight"
  lane :beta do
    build
    
    upload_to_testflight(
      app_identifier: "com.mirror-labs.MirrorSmokerStopper",
      skip_waiting_for_build_processing: false,
      skip_submission: false,
      
      # Beta Review Information
      beta_app_review_info: {
        contact_email: "roberdan@microsoft.com",
        contact_first_name: "Roberto",
        contact_last_name: "D'Angelo",
        contact_phone: "+39 123 456 7890",
        demo_account_name: "",
        demo_account_password: "",
        notes: "Test version of Fight The Smoke - smoking tracker app with AI coaching features."
      },
      
      # Changelog for testers
      changelog: "üî• NEW AI COACH FEATURE\n‚Ä¢ Personalized insights and recommendations\n‚Ä¢ Smart pattern recognition\n‚Ä¢ Enhanced analytics dashboard\n‚Ä¢ Improved Apple Watch integration\n‚Ä¢ Performance optimizations"
    )
    
    UI.success("‚úÖ App submitted to TestFlight!")
  end
  
  desc "üè™ Submit to App Store"
  lane :release do
    build
    
    # Upload to App Store
    upload_to_app_store(
      app_identifier: "com.mirror-labs.MirrorSmokerStopper",
      force: true,
      skip_screenshots: false,
      skip_metadata: false,
      
      # Screenshots and metadata
      screenshots_path: "./screenshots",
      
      # Submission information
      submit_for_review: true,
      automatic_release: false,
      
      # App Review Information
      app_review_information: {
        first_name: "Roberto",
        last_name: "D'Angelo", 
        phone_number: "+39 123 456 7890",
        email_address: "roberdan@microsoft.com",
        demo_account_name: "",
        demo_account_password: "",
        notes: "Fight The Smoke is a comprehensive smoking tracker app with AI-powered coaching. The app helps users monitor their smoking habits, provides personalized insights, and supports their journey towards healthier lifestyle choices."
      },
      
      # Export compliance (no encryption)
      submission_information: {
        export_compliance_platform: 'ios',
        export_compliance_compliance_required: false,
        export_compliance_encryption_updated: false,
        export_compliance_app_type: nil,
        export_compliance_uses_encryption: false,
        export_compliance_is_exempt: false,
        export_compliance_contains_third_party_cryptography: false,
        export_compliance_contains_proprietary_cryptography: false,
        export_compliance_available_on_french_store: true,
        content_rights_has_rights: true,
        content_rights_contains_third_party_content: false,
        add_id_info_limits_tracking: true,
        add_id_info_serves_ads: false,
        add_id_info_tracks_action: true,
        add_id_info_tracks_install: false,
        add_id_info_uses_idfa: false
      }
    )
    
    UI.success("‚úÖ App submitted to App Store for review!")
  end
  
  # ===== UTILITY LANES =====
  
  desc "üßπ Clean up build artifacts"
  lane :clean do
    clean_build_artifacts
    UI.success("‚úÖ Build artifacts cleaned!")
  end
  
  desc "üìä Generate app info report"
  lane :info do
    version = get_version_number(xcodeproj: "MirrorSmokerStopper.xcodeproj")
    build_number = get_build_number(xcodeproj: "MirrorSmokerStopper.xcodeproj")
    
    UI.message("üîç APP INFORMATION:")
    UI.message("   App Name: Fight The Smoke")
    UI.message("   Bundle ID: com.mirror-labs.MirrorSmokerStopper")
    UI.message("   Version: #{version}")
    UI.message("   Build: #{build_number}")
    UI.message("   Xcode Project: MirrorSmokerStopper.xcodeproj")
  end
  
  desc "üîÑ Complete deployment workflow"
  lane :deploy do
    info
    update_metadata
    upload_screenshots
    release
    
    UI.success("üéâ Complete deployment finished!")
  end
  
  # ===== ERROR HANDLING =====
  
  error do |lane, exception|
    UI.error("‚ùå Error in lane '#{lane}': #{exception}")
    
    # Add custom error handling here
    # slack(message: "Build failed!", success: false) if ENV['SLACK_URL']
  end
  
  after_all do |lane|
    UI.success("‚úÖ Lane '#{lane}' completed successfully!")
  end
end